<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Akshay Shankar">
<meta name="dcterms.date" content="2025-01-27">

<title>The callback pattern – ResearchTidbits</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-de070a7b0ab54f8780927367ac907214.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a0295b98df97165a7fbefc01603da993.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ResearchTidbits</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/20akshay00"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/20akshay00"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">The callback pattern</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">chunk</div>
                <div class="quarto-category">code</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Akshay Shankar </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 27, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>One of my favourite design patterns is the <code>Callback</code> (also known as the <a href="https://gameprogrammingpatterns.com/command.html"><code>Command</code></a> pattern in object-oriented contexts). Loosely speaking, a callback is simply a function <code>f</code> whose reference has been passed on to another function <code>g</code> which then proceeds to invoke <code>f</code> upon completion at a later time. It is trivially usable in languages that implement functions as first-class citizens (where they may be passed around as arguments with no hassle). While the idea is quite simple, it can lend itself to some very powerful and intuitive user interfaces! I’ve had natural use-cases arise both during my day-to-day research as well as during game development.</p>
<p>Let us consider a simple and perhaps a bit over-engineered example using Julia to demonstrate this idea. Say we want to write a generic interface for a differential equation solver. (Note that much of what I present here is simply a poor man’s version of the equivalent implementation in the behemoth that is <a href="https://docs.sciml.ai/DiffEqDocs/stable/">DifferentialEquations.jl</a>.)</p>
<section id="a-generic-integrator-interface" class="level1">
<h1>A generic integrator interface</h1>
<p><a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods">RK4</a> seems like a good place to start. We begin by defining a struct to hold the state of the integrator, <code>(u, tspan)</code>, where <code>u</code> can be anything that implements <code>similar</code> and supports basic algebraic operations and broadcasting, and <code>tspan</code> is an <code>AbstractRange</code> specifying the time interval of problem. The remaining variables are dummies to avoid allocation in a <a href="https://en.wikipedia.org/wiki/Hot_spot_(computer_programming)">hot loop</a>.</p>
<div id="25ac8b66" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract type</span> AbstractIntegrator <span class="kw">end</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> RK4Integrator{T,S} <span class="op">&lt;:</span><span class="dt"> AbstractIntegrator</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># current solver state</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    u<span class="op">::</span><span class="dt">T</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    tspan<span class="op">::</span><span class="dt">S</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intermediate variables</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    k1<span class="op">::</span><span class="dt">T</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    k2<span class="op">::</span><span class="dt">T</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    k3<span class="op">::</span><span class="dt">T</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    k4<span class="op">::</span><span class="dt">T</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    tmp<span class="op">::</span><span class="dt">T</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">RK4Integrator</span>(u, tspan) <span class="op">=</span> <span class="fu">new</span><span class="dt">{typeof(u),typeof(tspan)}</span>(</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        u, tspan, <span class="fu">similar</span>(u), <span class="fu">similar</span>(u), <span class="fu">similar</span>(u), <span class="fu">similar</span>(u), <span class="fu">similar</span>(u)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Every integrator is expected to implement a <code>step!</code> method that expects a function <code>f!</code> implementing the in-place derivative, and performs the actual time-stepping.</p>
<div id="6d37a842" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">step!</span>(integrator<span class="op">::</span><span class="dt">RK4Integrator</span>, f!, t)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    (; u, tspan, k1, k2, k3, k4, tmp) <span class="op">=</span> integrator</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> <span class="fu">step</span>(tspan)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f!</span>(k1, u, t)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    @. tmp <span class="op">=</span> u <span class="op">+</span> dt <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> k1</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f!</span>(k2, tmp, t <span class="op">+</span> dt <span class="op">/</span> <span class="fl">2</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    @. tmp <span class="op">=</span> u <span class="op">+</span> dt <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> k2</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f!</span>(k3, tmp, t <span class="op">+</span> dt <span class="op">/</span> <span class="fl">2</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    @. tmp <span class="op">=</span> u <span class="op">+</span> dt <span class="op">*</span> k3</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f!</span>(k4, tmp, t <span class="op">+</span> dt)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    @. u <span class="op">+=</span> dt <span class="op">/</span> <span class="fl">6</span> <span class="op">*</span> (k1 <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> k2 <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> k3 <span class="op">+</span> k4)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="510">
<pre><code>step! (generic function with 1 method)</code></pre>
</div>
</div>
<p>Then, we require only one generic function that actually loops through the time-steps. Below we just implement a basic version, but there is nothing stopping us from being more sophisticated with adaptive algorithms as well.</p>
<div id="6b1047d2" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve!</span>(f!, u0, tspan; solver, (callback!)<span class="op">=</span>(iter, integrator) <span class="op">-&gt;</span> <span class="cn">nothing</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    integrator <span class="op">=</span> <span class="fu">solver</span>(u0, tspan)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iter <span class="kw">in</span> <span class="fu">eachindex</span>(tspan)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">step!</span>(integrator, f!, tspan[iter])</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">callback!</span>(iter, integrator)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="511">
<pre><code>solve! (generic function with 1 method)</code></pre>
</div>
</div>
<p>At this point, we introduce the notion of a callback as a mutating function that takes the input <code>(iter, integrator)::(Integer, AbstractIntegrator)</code> and is invoked at the end of every iteration. We will soon see that the callback can be utilized by the user to run custom logic within the integrator loop without ever having to touch the actual internals. In the meanwhile, we can now solve any ordinary differential equation with the RK4 method!</p>
<div id="edd184c0" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dfdt!</span>(du, u, t)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        du[<span class="fl">1</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>. <span class="op">*</span> u[<span class="fl">1</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">solve!</span>(dfdt!, [<span class="fl">5</span>.], <span class="fu">range</span>(<span class="fl">0</span>., <span class="fl">1</span>., length<span class="op">=</span><span class="fl">100</span>), solver <span class="op">=</span> RK4Integrator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that this function only provides access to the value of <code>u</code> at the last time-step, which is a bit weird since typically we would want the evolution of the state as a time-series. While this was an oversight on my part, it also provides a good opportunity to utilize callbacks to store custom data during the solver steps. In order to do this, we may simply create a callback function like so. (Note that it is strictly necessary to wrap the keyword argument <code>callback!</code> in parenthesis because there is an ambiguity in syntax due to a possible <code>!=</code> otherwise.)</p>
<div id="52fda618" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we construct the callback inside another function to create a closure over `data` instead of leaving it as a global variable (which would degrade performance!)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">create_saving_callback</span>()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> []</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    saving_callback <span class="op">=</span> (iter, integrator) <span class="op">-&gt;</span> <span class="fu">push!</span>(data, integrator.u[<span class="fl">1</span>])</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data, saving_callback</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>data, saving_callback <span class="op">=</span> <span class="fu">create_saving_callback</span>()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">solve!</span>(dfdt!, [<span class="fl">5</span>.], <span class="fu">range</span>(<span class="fl">0</span>., <span class="fl">1</span>., length<span class="op">=</span><span class="fl">100</span>), solver <span class="op">=</span> RK4Integrator, (callback!)<span class="op">=</span>saving_callback)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="513">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip230">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip230)" d="M0 1920 L2688 1920 L2688 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip231">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip230)" d="M115.057 1800.78 L2640.76 1800.78 L2640.76 47.2441 L115.057 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip232">
    <rect x="115" y="47" width="2527" height="1755"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="162.471,1800.78 162.471,47.2441 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="764.172,1800.78 764.172,47.2441 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1365.87,1800.78 1365.87,47.2441 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1967.57,1800.78 1967.57,47.2441 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2569.27,1800.78 2569.27,47.2441 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1762.37 2640.76,1762.37 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1412.02 2640.76,1412.02 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1061.66 2640.76,1061.66 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,711.307 2640.76,711.307 "></polyline>
<polyline clip-path="url(#clip232)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,360.951 2640.76,360.951 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="162.471,1800.78 162.471,1781.88 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="764.172,1800.78 764.172,1781.88 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1365.87,1800.78 1365.87,1781.88 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1967.57,1800.78 1967.57,1781.88 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2569.27,1800.78 2569.27,1781.88 "></polyline>
<path clip-path="url(#clip230)" d="M162.471 1834 Q158.86 1834 157.031 1837.57 Q155.226 1841.11 155.226 1848.24 Q155.226 1855.34 157.031 1858.91 Q158.86 1862.45 162.471 1862.45 Q166.105 1862.45 167.911 1858.91 Q169.74 1855.34 169.74 1848.24 Q169.74 1841.11 167.911 1837.57 Q166.105 1834 162.471 1834 M162.471 1830.3 Q168.281 1830.3 171.337 1834.9 Q174.416 1839.49 174.416 1848.24 Q174.416 1856.96 171.337 1861.57 Q168.281 1866.15 162.471 1866.15 Q156.661 1866.15 153.582 1861.57 Q150.527 1856.96 150.527 1848.24 Q150.527 1839.49 153.582 1834.9 Q156.661 1830.3 162.471 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M743.443 1861.55 L759.762 1861.55 L759.762 1865.48 L737.818 1865.48 L737.818 1861.55 Q740.48 1858.79 745.063 1854.16 Q749.67 1849.51 750.85 1848.17 Q753.096 1845.65 753.975 1843.91 Q754.878 1842.15 754.878 1840.46 Q754.878 1837.71 752.933 1835.97 Q751.012 1834.23 747.91 1834.23 Q745.711 1834.23 743.258 1835 Q740.827 1835.76 738.049 1837.31 L738.049 1832.59 Q740.873 1831.46 743.327 1830.88 Q745.781 1830.3 747.818 1830.3 Q753.188 1830.3 756.383 1832.98 Q759.577 1835.67 759.577 1840.16 Q759.577 1842.29 758.767 1844.21 Q757.98 1846.11 755.873 1848.7 Q755.295 1849.37 752.193 1852.59 Q749.091 1855.78 743.443 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M769.623 1830.92 L787.98 1830.92 L787.98 1834.86 L773.906 1834.86 L773.906 1843.33 Q774.924 1842.98 775.943 1842.82 Q776.961 1842.64 777.98 1842.64 Q783.767 1842.64 787.146 1845.81 Q790.526 1848.98 790.526 1854.4 Q790.526 1859.97 787.054 1863.08 Q783.581 1866.15 777.262 1866.15 Q775.086 1866.15 772.818 1865.78 Q770.572 1865.41 768.165 1864.67 L768.165 1859.97 Q770.248 1861.11 772.47 1861.66 Q774.693 1862.22 777.169 1862.22 Q781.174 1862.22 783.512 1860.11 Q785.85 1858.01 785.85 1854.4 Q785.85 1850.78 783.512 1848.68 Q781.174 1846.57 777.169 1846.57 Q775.294 1846.57 773.419 1846.99 Q771.568 1847.4 769.623 1848.28 L769.623 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M1340.57 1830.92 L1358.93 1830.92 L1358.93 1834.86 L1344.85 1834.86 L1344.85 1843.33 Q1345.87 1842.98 1346.89 1842.82 Q1347.91 1842.64 1348.93 1842.64 Q1354.72 1842.64 1358.09 1845.81 Q1361.47 1848.98 1361.47 1854.4 Q1361.47 1859.97 1358 1863.08 Q1354.53 1866.15 1348.21 1866.15 Q1346.03 1866.15 1343.77 1865.78 Q1341.52 1865.41 1339.11 1864.67 L1339.11 1859.97 Q1341.2 1861.11 1343.42 1861.66 Q1345.64 1862.22 1348.12 1862.22 Q1352.12 1862.22 1354.46 1860.11 Q1356.8 1858.01 1356.8 1854.4 Q1356.8 1850.78 1354.46 1848.68 Q1352.12 1846.57 1348.12 1846.57 Q1346.24 1846.57 1344.37 1846.99 Q1342.52 1847.4 1340.57 1848.28 L1340.57 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M1380.69 1834 Q1377.08 1834 1375.25 1837.57 Q1373.44 1841.11 1373.44 1848.24 Q1373.44 1855.34 1375.25 1858.91 Q1377.08 1862.45 1380.69 1862.45 Q1384.32 1862.45 1386.13 1858.91 Q1387.96 1855.34 1387.96 1848.24 Q1387.96 1841.11 1386.13 1837.57 Q1384.32 1834 1380.69 1834 M1380.69 1830.3 Q1386.5 1830.3 1389.55 1834.9 Q1392.63 1839.49 1392.63 1848.24 Q1392.63 1856.96 1389.55 1861.57 Q1386.5 1866.15 1380.69 1866.15 Q1374.88 1866.15 1371.8 1861.57 Q1368.74 1856.96 1368.74 1848.24 Q1368.74 1839.49 1371.8 1834.9 Q1374.88 1830.3 1380.69 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M1941.43 1830.92 L1963.65 1830.92 L1963.65 1832.91 L1951.1 1865.48 L1946.22 1865.48 L1958.02 1834.86 L1941.43 1834.86 L1941.43 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M1972.82 1830.92 L1991.17 1830.92 L1991.17 1834.86 L1977.1 1834.86 L1977.1 1843.33 Q1978.12 1842.98 1979.14 1842.82 Q1980.15 1842.64 1981.17 1842.64 Q1986.96 1842.64 1990.34 1845.81 Q1993.72 1848.98 1993.72 1854.4 Q1993.72 1859.97 1990.25 1863.08 Q1986.77 1866.15 1980.46 1866.15 Q1978.28 1866.15 1976.01 1865.78 Q1973.77 1865.41 1971.36 1864.67 L1971.36 1859.97 Q1973.44 1861.11 1975.66 1861.66 Q1977.89 1862.22 1980.36 1862.22 Q1984.37 1862.22 1986.71 1860.11 Q1989.04 1858.01 1989.04 1854.4 Q1989.04 1850.78 1986.71 1848.68 Q1984.37 1846.57 1980.36 1846.57 Q1978.49 1846.57 1976.61 1846.99 Q1974.76 1847.4 1972.82 1848.28 L1972.82 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M2528.88 1861.55 L2536.52 1861.55 L2536.52 1835.18 L2528.21 1836.85 L2528.21 1832.59 L2536.47 1830.92 L2541.15 1830.92 L2541.15 1861.55 L2548.79 1861.55 L2548.79 1865.48 L2528.88 1865.48 L2528.88 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M2568.23 1834 Q2564.62 1834 2562.79 1837.57 Q2560.99 1841.11 2560.99 1848.24 Q2560.99 1855.34 2562.79 1858.91 Q2564.62 1862.45 2568.23 1862.45 Q2571.87 1862.45 2573.67 1858.91 Q2575.5 1855.34 2575.5 1848.24 Q2575.5 1841.11 2573.67 1837.57 Q2571.87 1834 2568.23 1834 M2568.23 1830.3 Q2574.04 1830.3 2577.1 1834.9 Q2580.18 1839.49 2580.18 1848.24 Q2580.18 1856.96 2577.1 1861.57 Q2574.04 1866.15 2568.23 1866.15 Q2562.42 1866.15 2559.34 1861.57 Q2556.29 1856.96 2556.29 1848.24 Q2556.29 1839.49 2559.34 1834.9 Q2562.42 1830.3 2568.23 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M2598.39 1834 Q2594.78 1834 2592.95 1837.57 Q2591.15 1841.11 2591.15 1848.24 Q2591.15 1855.34 2592.95 1858.91 Q2594.78 1862.45 2598.39 1862.45 Q2602.03 1862.45 2603.83 1858.91 Q2605.66 1855.34 2605.66 1848.24 Q2605.66 1841.11 2603.83 1837.57 Q2602.03 1834 2598.39 1834 M2598.39 1830.3 Q2604.2 1830.3 2607.26 1834.9 Q2610.34 1839.49 2610.34 1848.24 Q2610.34 1856.96 2607.26 1861.57 Q2604.2 1866.15 2598.39 1866.15 Q2592.58 1866.15 2589.51 1861.57 Q2586.45 1856.96 2586.45 1848.24 Q2586.45 1839.49 2589.51 1834.9 Q2592.58 1830.3 2598.39 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 115.057,47.2441 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1762.37 133.955,1762.37 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1412.02 133.955,1412.02 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1061.66 133.955,1061.66 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,711.307 133.955,711.307 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,360.951 133.955,360.951 "></polyline>
<path clip-path="url(#clip230)" d="M62.7928 1748.17 Q59.1817 1748.17 57.353 1751.74 Q55.5475 1755.28 55.5475 1762.41 Q55.5475 1769.51 57.353 1773.08 Q59.1817 1776.62 62.7928 1776.62 Q66.427 1776.62 68.2326 1773.08 Q70.0613 1769.51 70.0613 1762.41 Q70.0613 1755.28 68.2326 1751.74 Q66.427 1748.17 62.7928 1748.17 M62.7928 1744.47 Q68.6029 1744.47 71.6585 1749.07 Q74.7372 1753.66 74.7372 1762.41 Q74.7372 1771.13 71.6585 1775.74 Q68.6029 1780.32 62.7928 1780.32 Q56.9826 1780.32 53.904 1775.74 Q50.8484 1771.13 50.8484 1762.41 Q50.8484 1753.66 53.904 1749.07 Q56.9826 1744.47 62.7928 1744.47 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M54.8299 1425.36 L62.4687 1425.36 L62.4687 1399 L54.1586 1400.66 L54.1586 1396.4 L62.4224 1394.74 L67.0983 1394.74 L67.0983 1425.36 L74.7372 1425.36 L74.7372 1429.3 L54.8299 1429.3 L54.8299 1425.36 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M58.4178 1075.01 L74.7372 1075.01 L74.7372 1078.94 L52.7928 1078.94 L52.7928 1075.01 Q55.4549 1072.25 60.0382 1067.62 Q64.6446 1062.97 65.8252 1061.63 Q68.0705 1059.1 68.9502 1057.37 Q69.8529 1055.61 69.8529 1053.92 Q69.8529 1051.16 67.9085 1049.43 Q65.9872 1047.69 62.8854 1047.69 Q60.6863 1047.69 58.2326 1048.46 Q55.8021 1049.22 53.0243 1050.77 L53.0243 1046.05 Q55.8484 1044.91 58.3021 1044.34 Q60.7558 1043.76 62.7928 1043.76 Q68.1631 1043.76 71.3576 1046.44 Q74.552 1049.13 74.552 1053.62 Q74.552 1055.75 73.7418 1057.67 Q72.9548 1059.57 70.8483 1062.16 Q70.2696 1062.83 67.1678 1066.05 Q64.0659 1069.24 58.4178 1075.01 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M67.6076 709.953 Q70.964 710.67 72.839 712.939 Q74.7372 715.207 74.7372 718.541 Q74.7372 723.656 71.2187 726.457 Q67.7002 729.258 61.2187 729.258 Q59.0428 729.258 56.728 728.818 Q54.4364 728.402 51.9827 727.545 L51.9827 723.031 Q53.9271 724.165 56.2419 724.744 Q58.5567 725.323 61.0798 725.323 Q65.478 725.323 67.7696 723.587 Q70.0844 721.851 70.0844 718.541 Q70.0844 715.485 67.9317 713.772 Q65.802 712.036 61.9826 712.036 L57.9549 712.036 L57.9549 708.193 L62.1678 708.193 Q65.6169 708.193 67.4455 706.828 Q69.2742 705.439 69.2742 702.846 Q69.2742 700.184 67.3761 698.772 Q65.5011 697.337 61.9826 697.337 Q60.0613 697.337 57.8623 697.754 Q55.6632 698.17 53.0243 699.05 L53.0243 694.883 Q55.6864 694.142 58.0012 693.772 Q60.3391 693.402 62.3993 693.402 Q67.7233 693.402 70.8252 695.832 Q73.927 698.24 73.927 702.36 Q73.927 705.23 72.2835 707.221 Q70.64 709.189 67.6076 709.953 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M65.1539 347.745 L53.3484 366.194 L65.1539 366.194 L65.1539 347.745 M63.927 343.671 L69.8066 343.671 L69.8066 366.194 L74.7372 366.194 L74.7372 370.083 L69.8066 370.083 L69.8066 378.231 L65.1539 378.231 L65.1539 370.083 L49.5521 370.083 L49.5521 365.569 L63.927 343.671 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip232)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="186.539,96.8724 210.607,178.9 234.675,256.887 258.743,331.034 282.811,401.528 306.879,468.551 330.947,532.273 355.015,592.857 379.083,650.456 403.151,705.219 427.219,757.285 451.288,806.786 475.356,853.85 499.424,898.595 523.492,941.137 547.56,981.584 571.628,1020.04 595.696,1056.6 619.764,1091.36 643.832,1124.41 667.9,1155.83 691.968,1185.7 716.036,1214.1 740.104,1241.1 764.172,1266.78 788.24,1291.19 812.308,1314.39 836.376,1336.46 860.444,1357.43 884.512,1377.38 908.58,1396.34 932.648,1414.37 956.716,1431.51 980.784,1447.8 1004.85,1463.29 1028.92,1478.02 1052.99,1492.03 1077.06,1505.34 1101.12,1518 1125.19,1530.04 1149.26,1541.48 1173.33,1552.36 1197.4,1562.7 1221.46,1572.54 1245.53,1581.89 1269.6,1590.78 1293.67,1599.23 1317.74,1607.26 1341.8,1614.9 1365.87,1622.16 1389.94,1629.07 1414.01,1635.63 1438.08,1641.88 1462.14,1647.81 1486.21,1653.45 1510.28,1658.82 1534.35,1663.92 1558.42,1668.77 1582.48,1673.38 1606.55,1677.76 1630.62,1681.93 1654.69,1685.89 1678.76,1689.66 1702.82,1693.24 1726.89,1696.64 1750.96,1699.88 1775.03,1702.96 1799.1,1705.88 1823.17,1708.67 1847.23,1711.31 1871.3,1713.83 1895.37,1716.22 1919.44,1718.49 1943.51,1720.65 1967.57,1722.71 1991.64,1724.66 2015.71,1726.52 2039.78,1728.28 2063.85,1729.96 2087.91,1731.56 2111.98,1733.08 2136.05,1734.52 2160.12,1735.89 2184.19,1737.2 2208.25,1738.44 2232.32,1739.61 2256.39,1740.74 2280.46,1741.8 2304.53,1742.81 2328.59,1743.78 2352.66,1744.69 2376.73,1745.56 2400.8,1746.39 2424.87,1747.18 2448.93,1747.93 2473,1748.64 2497.07,1749.32 2521.14,1749.96 2545.21,1750.57 2569.27,1751.15 "></polyline>
<path clip-path="url(#clip230)" d="M2251.57 209.375 L2556.57 209.375 L2556.57 105.695 L2251.57 105.695  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip230)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2251.57,209.375 2556.57,209.375 2556.57,105.695 2251.57,105.695 2251.57,209.375 "></polyline>
<polyline clip-path="url(#clip230)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2279.63,157.535 2448.01,157.535 "></polyline>
<path clip-path="url(#clip230)" d="M2489.91 177.223 Q2488.11 181.852 2486.4 183.264 Q2484.68 184.676 2481.81 184.676 L2478.41 184.676 L2478.41 181.112 L2480.91 181.112 Q2482.67 181.112 2483.64 180.278 Q2484.61 179.445 2485.79 176.343 L2486.56 174.399 L2476.07 148.889 L2480.59 148.889 L2488.69 169.167 L2496.79 148.889 L2501.3 148.889 L2489.91 177.223 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip230)" d="M2508.6 170.88 L2516.23 170.88 L2516.23 144.515 L2507.92 146.181 L2507.92 141.922 L2516.19 140.255 L2520.86 140.255 L2520.86 170.88 L2528.5 170.88 L2528.5 174.815 L2508.6 174.815 L2508.6 170.88 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
</div>
<p>This works perfectly fine and is exactly what one would (should?) do for personal code! However, this is not a very modular approach. If the goal is to build a package with an intuitive and flexible user-facing API, we can build upon this a lot more to account for common use-cases. Let us see a possible way to achieve this.</p>
<section id="a-small-aside" class="level2">
<h2 class="anchored" data-anchor-id="a-small-aside">A small aside</h2>
<p>Generally, custom logic can be stateful (i.e, have persistent local variables) and one would need to create a <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">closure</a> over the function that actually performs the mutating action on the state of the integrator (just like we did above). However, Julia offers another alternative; namely, we can define a struct that encapsulates the data, which can then be <a href="https://docs.julialang.org/en/v1/manual/methods/#Function-like-objects">invoked as a function</a> with access to this data. Since both structs and functions may be invoked by means of a function call syntax, I will generically refer to them as <code>callables</code> henceforth.</p>
</section>
</section>
<section id="the-callback-struct" class="level1">
<h1>The callback struct</h1>
<p>In order to define a generic interface, we first need to think about what the general use-case of callbacks would be. In the context of an integrator, we expect that callbacks will always have the specific form of evaluating whether a certain <code>condition</code> is met at the time of invocation, and if so, it performs a certain <code>effect</code> that may mutate the state of the integrator. For example, we may want to compute and save a certain quantity every iteration, or normalize the state whenever it deviates beyond a certain threshold, or apply a periodic perturbation every 10 iterations, etc. So, we define a <code>Callback</code> struct as a collection of two callables; (1) <code>condition</code> with signature <code>(iter, integrator) -&gt; bool</code> and (2) <code>effect</code> with signature <code>(iter, integrator) -&gt; integrator</code>, although it can be mutating as well.</p>
<div id="caadb4d8" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Callback{C,E}</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"condition for performing callback: (iter, integrator) -&gt; bool"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        condition<span class="op">::</span><span class="dt">C</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"callback function acting on solver state: (iter, integrator) -&gt; integrator"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        effect<span class="op">::</span><span class="dt">E</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> (p<span class="op">::</span><span class="dt">Callback</span>)(iter, integrator)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p.<span class="fu">condition</span>(iter, integrator)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            p.<span class="fu">effect</span>(iter, integrator)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> integrator</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can further define a <code>CallbackList</code> that sequentially invokes its elements if we have more than one callback.</p>
<div id="f3f261d1" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> CallbackList</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        callbacks<span class="op">::</span><span class="dt">Vector{Callback}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> (p<span class="op">::</span><span class="dt">CallbackList</span>)(iter, integrator)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> callback <span class="kw">in</span> p.callbacks</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">callback</span>(iter, integrator)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> integrator</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Base</span>.<span class="fu">getindex</span>(p<span class="op">::</span><span class="dt">CallbackList</span>, idx) <span class="op">=</span> <span class="fu">getindex</span>(p.callbacks, idx)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Base</span>.<span class="fu">length</span>(p<span class="op">::</span><span class="dt">CallbackList</span>) <span class="op">=</span> <span class="fu">length</span>(p.callbacks)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="some-common-conditions-and-effects" class="level1">
<h1>Some common conditions and effects</h1>
<p>Now that the basic structure is in place, let us implement some <code>condition</code>s that may be required quite often. Again, these don’t <em>have</em> to be structs, but since the specific use-cases here require statefulness, they are an appropriate choice. Note that we have not placed explicit safegaurds to statically check whether the function call has the right signature, so the program would fail at run-time if the signature does not match what is expected.</p>
<div id="91585e8b" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trigger every n iterations</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mutable struct</span> OnIterElapsed</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"number of iterations between trigger"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        save_freq<span class="op">::</span><span class="dt">Int</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        loop<span class="op">::</span><span class="dt">Bool </span><span class="co"># if true, continuously fires, otherwise it is a one-shot condition</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        flag<span class="op">::</span><span class="dt">Bool </span><span class="co"># true if condition has been fired once</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">OnIterElapsed</span>(save_freq, loop<span class="op">=</span><span class="cn">true</span>) <span class="op">=</span> <span class="fu">new</span>(save_freq, loop, <span class="cn">false</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> (p<span class="op">::</span><span class="dt">OnIterElapsed</span>)(iter, integrator)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> <span class="fu">iszero</span>(iter <span class="op">%</span> p.save_freq)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> p.loop ? res <span class="op">:</span> (!p.flag ? (p.flag <span class="op">=</span> res; p.flag) <span class="op">:</span> <span class="cn">false</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># maybe for saving data to file as a backup during long program runs</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mutable struct</span> OnRealTimeElapsed</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"starting time in seconds"</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        start_tick<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"number of seconds between trigger"</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        save_freq<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># :s - second, :m - minute, :h - hour</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">function</span> <span class="fu">OnRealTimeElapsed</span>(freq, unit<span class="op">=:</span>m)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> unit <span class="op">==</span> <span class="op">:</span>m</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                freq <span class="op">*=</span> <span class="fl">60</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elseif</span> unit <span class="op">==</span> <span class="op">:</span>h</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                freq <span class="op">*=</span> <span class="fl">3600</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elseif</span> unit <span class="op">!=</span> <span class="op">:</span>s</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                <span class="fu">throw</span>(<span class="fu">ArgumentError</span>(<span class="st">"invalid unit `:</span><span class="sc">$</span>unit<span class="st">`, expected `:s`, `:m` or `:h`"</span>))</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">new</span>(<span class="fu">time</span>(), freq)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only gets called AFTER an iteration is complete!</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    (p<span class="op">::</span><span class="dt">OnRealTimeElapsed</span>)(iter, state, H, envs) <span class="op">=</span> ((<span class="fu">time</span>() <span class="op">-</span> p.start_tick) <span class="op">&gt;</span> p.save_freq) ? (p.start_tick <span class="op">=</span> <span class="fu">time</span>(); <span class="cn">true</span>) <span class="op">:</span> <span class="cn">false</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now define a generic <code>effect</code> that simply computes some specified observables using the integrator state. We do so by defining a struct <code>RecordObservable</code> which expects an input <code>recipe</code> which is a named tuple containing a collection of (<code>observable_name</code> = <code>function_to_compute_observable</code>). For example; <code>(norm = (iter, integrator) -&gt; norm(integrator.u), iter = (iter, integrator) -&gt; iter)</code>. It then stores the result in <code>data</code> whenever the <code>condition</code> of its parent <code>Callback</code> returns <code>true</code>. While this is a trivial example, it may be quite useful if there is some non-trivial internal integrator state that must be tracked.</p>
<div id="65370230" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> RecordObservable{D,O}</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"collection of string-array pairs containing observable data"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        data<span class="op">::</span><span class="dt">D</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"functions to compute observable data"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        observables<span class="op">::</span><span class="dt">O</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">function</span> <span class="fu">RecordObservable</span>(recipe)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            names <span class="op">=</span> <span class="fu">keys</span>(recipe)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            observables <span class="op">=</span> <span class="fu">values</span>(recipe)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> <span class="fu">NamedTuple</span><span class="dt">{names}</span>(([] <span class="cf">for</span> _ <span class="kw">in</span> <span class="fu">eachindex</span>(names)))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">new</span><span class="dt">{typeof(data),typeof(observables)}</span>(data, observables)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to access the data without an extra .data; bit iffy, but functional</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">getproperty</span>(p<span class="op">::</span><span class="dt">RecordObservable</span>, key<span class="op">::</span><span class="dt">Symbol</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> <span class="fu">fieldnames</span>(<span class="fu">typeof</span>(p))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">getfield</span>(p, key)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">getproperty</span>(p.data, key)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Base</span>.<span class="fu">length</span>(p<span class="op">::</span><span class="dt">RecordObservable</span>) <span class="op">=</span> <span class="fu">length</span>(p.data)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> (p<span class="op">::</span><span class="dt">RecordObservable</span>)(iter, integrator)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(p)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">push!</span>(p.data[i], p.observables[i](iter, integrator))</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> integrator</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Having done this, we can now once again visualize the solution as a time-series at every iteration.</p>
<div id="62106d3f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    record_state <span class="op">=</span> <span class="fu">Callback</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">OnIterElapsed</span>(<span class="fl">1</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">RecordObservable</span>((u<span class="op">=</span>(iter, integrator) <span class="op">-&gt;</span> integrator.u[<span class="fl">1</span>],))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">solve!</span>(dfdt!, [<span class="fl">5.0</span>], <span class="fu">range</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>, length<span class="op">=</span><span class="fl">100</span>), solver<span class="op">=</span>RK4Integrator, (callback!)<span class="op">=</span>record_state)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(record_state.effect.u)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="518">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip320">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip320)" d="M0 1920 L2688 1920 L2688 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip321">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip320)" d="M115.057 1800.78 L2640.76 1800.78 L2640.76 47.2441 L115.057 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip322">
    <rect x="115" y="47" width="2527" height="1755"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="162.471,1800.78 162.471,47.2441 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="764.172,1800.78 764.172,47.2441 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1365.87,1800.78 1365.87,47.2441 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1967.57,1800.78 1967.57,47.2441 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2569.27,1800.78 2569.27,47.2441 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1762.37 2640.76,1762.37 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1412.02 2640.76,1412.02 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1061.66 2640.76,1061.66 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,711.307 2640.76,711.307 "></polyline>
<polyline clip-path="url(#clip322)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,360.951 2640.76,360.951 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="162.471,1800.78 162.471,1781.88 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="764.172,1800.78 764.172,1781.88 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1365.87,1800.78 1365.87,1781.88 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1967.57,1800.78 1967.57,1781.88 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2569.27,1800.78 2569.27,1781.88 "></polyline>
<path clip-path="url(#clip320)" d="M162.471 1834 Q158.86 1834 157.031 1837.57 Q155.226 1841.11 155.226 1848.24 Q155.226 1855.34 157.031 1858.91 Q158.86 1862.45 162.471 1862.45 Q166.105 1862.45 167.911 1858.91 Q169.74 1855.34 169.74 1848.24 Q169.74 1841.11 167.911 1837.57 Q166.105 1834 162.471 1834 M162.471 1830.3 Q168.281 1830.3 171.337 1834.9 Q174.416 1839.49 174.416 1848.24 Q174.416 1856.96 171.337 1861.57 Q168.281 1866.15 162.471 1866.15 Q156.661 1866.15 153.582 1861.57 Q150.527 1856.96 150.527 1848.24 Q150.527 1839.49 153.582 1834.9 Q156.661 1830.3 162.471 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M743.443 1861.55 L759.762 1861.55 L759.762 1865.48 L737.818 1865.48 L737.818 1861.55 Q740.48 1858.79 745.063 1854.16 Q749.67 1849.51 750.85 1848.17 Q753.096 1845.65 753.975 1843.91 Q754.878 1842.15 754.878 1840.46 Q754.878 1837.71 752.933 1835.97 Q751.012 1834.23 747.91 1834.23 Q745.711 1834.23 743.258 1835 Q740.827 1835.76 738.049 1837.31 L738.049 1832.59 Q740.873 1831.46 743.327 1830.88 Q745.781 1830.3 747.818 1830.3 Q753.188 1830.3 756.383 1832.98 Q759.577 1835.67 759.577 1840.16 Q759.577 1842.29 758.767 1844.21 Q757.98 1846.11 755.873 1848.7 Q755.295 1849.37 752.193 1852.59 Q749.091 1855.78 743.443 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M769.623 1830.92 L787.98 1830.92 L787.98 1834.86 L773.906 1834.86 L773.906 1843.33 Q774.924 1842.98 775.943 1842.82 Q776.961 1842.64 777.98 1842.64 Q783.767 1842.64 787.146 1845.81 Q790.526 1848.98 790.526 1854.4 Q790.526 1859.97 787.054 1863.08 Q783.581 1866.15 777.262 1866.15 Q775.086 1866.15 772.818 1865.78 Q770.572 1865.41 768.165 1864.67 L768.165 1859.97 Q770.248 1861.11 772.47 1861.66 Q774.693 1862.22 777.169 1862.22 Q781.174 1862.22 783.512 1860.11 Q785.85 1858.01 785.85 1854.4 Q785.85 1850.78 783.512 1848.68 Q781.174 1846.57 777.169 1846.57 Q775.294 1846.57 773.419 1846.99 Q771.568 1847.4 769.623 1848.28 L769.623 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M1340.57 1830.92 L1358.93 1830.92 L1358.93 1834.86 L1344.85 1834.86 L1344.85 1843.33 Q1345.87 1842.98 1346.89 1842.82 Q1347.91 1842.64 1348.93 1842.64 Q1354.72 1842.64 1358.09 1845.81 Q1361.47 1848.98 1361.47 1854.4 Q1361.47 1859.97 1358 1863.08 Q1354.53 1866.15 1348.21 1866.15 Q1346.03 1866.15 1343.77 1865.78 Q1341.52 1865.41 1339.11 1864.67 L1339.11 1859.97 Q1341.2 1861.11 1343.42 1861.66 Q1345.64 1862.22 1348.12 1862.22 Q1352.12 1862.22 1354.46 1860.11 Q1356.8 1858.01 1356.8 1854.4 Q1356.8 1850.78 1354.46 1848.68 Q1352.12 1846.57 1348.12 1846.57 Q1346.24 1846.57 1344.37 1846.99 Q1342.52 1847.4 1340.57 1848.28 L1340.57 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M1380.69 1834 Q1377.08 1834 1375.25 1837.57 Q1373.44 1841.11 1373.44 1848.24 Q1373.44 1855.34 1375.25 1858.91 Q1377.08 1862.45 1380.69 1862.45 Q1384.32 1862.45 1386.13 1858.91 Q1387.96 1855.34 1387.96 1848.24 Q1387.96 1841.11 1386.13 1837.57 Q1384.32 1834 1380.69 1834 M1380.69 1830.3 Q1386.5 1830.3 1389.55 1834.9 Q1392.63 1839.49 1392.63 1848.24 Q1392.63 1856.96 1389.55 1861.57 Q1386.5 1866.15 1380.69 1866.15 Q1374.88 1866.15 1371.8 1861.57 Q1368.74 1856.96 1368.74 1848.24 Q1368.74 1839.49 1371.8 1834.9 Q1374.88 1830.3 1380.69 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M1941.43 1830.92 L1963.65 1830.92 L1963.65 1832.91 L1951.1 1865.48 L1946.22 1865.48 L1958.02 1834.86 L1941.43 1834.86 L1941.43 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M1972.82 1830.92 L1991.17 1830.92 L1991.17 1834.86 L1977.1 1834.86 L1977.1 1843.33 Q1978.12 1842.98 1979.14 1842.82 Q1980.15 1842.64 1981.17 1842.64 Q1986.96 1842.64 1990.34 1845.81 Q1993.72 1848.98 1993.72 1854.4 Q1993.72 1859.97 1990.25 1863.08 Q1986.77 1866.15 1980.46 1866.15 Q1978.28 1866.15 1976.01 1865.78 Q1973.77 1865.41 1971.36 1864.67 L1971.36 1859.97 Q1973.44 1861.11 1975.66 1861.66 Q1977.89 1862.22 1980.36 1862.22 Q1984.37 1862.22 1986.71 1860.11 Q1989.04 1858.01 1989.04 1854.4 Q1989.04 1850.78 1986.71 1848.68 Q1984.37 1846.57 1980.36 1846.57 Q1978.49 1846.57 1976.61 1846.99 Q1974.76 1847.4 1972.82 1848.28 L1972.82 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M2528.88 1861.55 L2536.52 1861.55 L2536.52 1835.18 L2528.21 1836.85 L2528.21 1832.59 L2536.47 1830.92 L2541.15 1830.92 L2541.15 1861.55 L2548.79 1861.55 L2548.79 1865.48 L2528.88 1865.48 L2528.88 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M2568.23 1834 Q2564.62 1834 2562.79 1837.57 Q2560.99 1841.11 2560.99 1848.24 Q2560.99 1855.34 2562.79 1858.91 Q2564.62 1862.45 2568.23 1862.45 Q2571.87 1862.45 2573.67 1858.91 Q2575.5 1855.34 2575.5 1848.24 Q2575.5 1841.11 2573.67 1837.57 Q2571.87 1834 2568.23 1834 M2568.23 1830.3 Q2574.04 1830.3 2577.1 1834.9 Q2580.18 1839.49 2580.18 1848.24 Q2580.18 1856.96 2577.1 1861.57 Q2574.04 1866.15 2568.23 1866.15 Q2562.42 1866.15 2559.34 1861.57 Q2556.29 1856.96 2556.29 1848.24 Q2556.29 1839.49 2559.34 1834.9 Q2562.42 1830.3 2568.23 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M2598.39 1834 Q2594.78 1834 2592.95 1837.57 Q2591.15 1841.11 2591.15 1848.24 Q2591.15 1855.34 2592.95 1858.91 Q2594.78 1862.45 2598.39 1862.45 Q2602.03 1862.45 2603.83 1858.91 Q2605.66 1855.34 2605.66 1848.24 Q2605.66 1841.11 2603.83 1837.57 Q2602.03 1834 2598.39 1834 M2598.39 1830.3 Q2604.2 1830.3 2607.26 1834.9 Q2610.34 1839.49 2610.34 1848.24 Q2610.34 1856.96 2607.26 1861.57 Q2604.2 1866.15 2598.39 1866.15 Q2592.58 1866.15 2589.51 1861.57 Q2586.45 1856.96 2586.45 1848.24 Q2586.45 1839.49 2589.51 1834.9 Q2592.58 1830.3 2598.39 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 115.057,47.2441 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1762.37 133.955,1762.37 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1412.02 133.955,1412.02 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1061.66 133.955,1061.66 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,711.307 133.955,711.307 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,360.951 133.955,360.951 "></polyline>
<path clip-path="url(#clip320)" d="M62.7928 1748.17 Q59.1817 1748.17 57.353 1751.74 Q55.5475 1755.28 55.5475 1762.41 Q55.5475 1769.51 57.353 1773.08 Q59.1817 1776.62 62.7928 1776.62 Q66.427 1776.62 68.2326 1773.08 Q70.0613 1769.51 70.0613 1762.41 Q70.0613 1755.28 68.2326 1751.74 Q66.427 1748.17 62.7928 1748.17 M62.7928 1744.47 Q68.6029 1744.47 71.6585 1749.07 Q74.7372 1753.66 74.7372 1762.41 Q74.7372 1771.13 71.6585 1775.74 Q68.6029 1780.32 62.7928 1780.32 Q56.9826 1780.32 53.904 1775.74 Q50.8484 1771.13 50.8484 1762.41 Q50.8484 1753.66 53.904 1749.07 Q56.9826 1744.47 62.7928 1744.47 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M54.8299 1425.36 L62.4687 1425.36 L62.4687 1399 L54.1586 1400.66 L54.1586 1396.4 L62.4224 1394.74 L67.0983 1394.74 L67.0983 1425.36 L74.7372 1425.36 L74.7372 1429.3 L54.8299 1429.3 L54.8299 1425.36 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M58.4178 1075.01 L74.7372 1075.01 L74.7372 1078.94 L52.7928 1078.94 L52.7928 1075.01 Q55.4549 1072.25 60.0382 1067.62 Q64.6446 1062.97 65.8252 1061.63 Q68.0705 1059.1 68.9502 1057.37 Q69.8529 1055.61 69.8529 1053.92 Q69.8529 1051.16 67.9085 1049.43 Q65.9872 1047.69 62.8854 1047.69 Q60.6863 1047.69 58.2326 1048.46 Q55.8021 1049.22 53.0243 1050.77 L53.0243 1046.05 Q55.8484 1044.91 58.3021 1044.34 Q60.7558 1043.76 62.7928 1043.76 Q68.1631 1043.76 71.3576 1046.44 Q74.552 1049.13 74.552 1053.62 Q74.552 1055.75 73.7418 1057.67 Q72.9548 1059.57 70.8483 1062.16 Q70.2696 1062.83 67.1678 1066.05 Q64.0659 1069.24 58.4178 1075.01 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M67.6076 709.953 Q70.964 710.67 72.839 712.939 Q74.7372 715.207 74.7372 718.541 Q74.7372 723.656 71.2187 726.457 Q67.7002 729.258 61.2187 729.258 Q59.0428 729.258 56.728 728.818 Q54.4364 728.402 51.9827 727.545 L51.9827 723.031 Q53.9271 724.165 56.2419 724.744 Q58.5567 725.323 61.0798 725.323 Q65.478 725.323 67.7696 723.587 Q70.0844 721.851 70.0844 718.541 Q70.0844 715.485 67.9317 713.772 Q65.802 712.036 61.9826 712.036 L57.9549 712.036 L57.9549 708.193 L62.1678 708.193 Q65.6169 708.193 67.4455 706.828 Q69.2742 705.439 69.2742 702.846 Q69.2742 700.184 67.3761 698.772 Q65.5011 697.337 61.9826 697.337 Q60.0613 697.337 57.8623 697.754 Q55.6632 698.17 53.0243 699.05 L53.0243 694.883 Q55.6864 694.142 58.0012 693.772 Q60.3391 693.402 62.3993 693.402 Q67.7233 693.402 70.8252 695.832 Q73.927 698.24 73.927 702.36 Q73.927 705.23 72.2835 707.221 Q70.64 709.189 67.6076 709.953 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M65.1539 347.745 L53.3484 366.194 L65.1539 366.194 L65.1539 347.745 M63.927 343.671 L69.8066 343.671 L69.8066 366.194 L74.7372 366.194 L74.7372 370.083 L69.8066 370.083 L69.8066 378.231 L65.1539 378.231 L65.1539 370.083 L49.5521 370.083 L49.5521 365.569 L63.927 343.671 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip322)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="186.539,96.8724 210.607,178.9 234.675,256.887 258.743,331.034 282.811,401.528 306.879,468.551 330.947,532.273 355.015,592.857 379.083,650.456 403.151,705.219 427.219,757.285 451.288,806.786 475.356,853.85 499.424,898.595 523.492,941.137 547.56,981.584 571.628,1020.04 595.696,1056.6 619.764,1091.36 643.832,1124.41 667.9,1155.83 691.968,1185.7 716.036,1214.1 740.104,1241.1 764.172,1266.78 788.24,1291.19 812.308,1314.39 836.376,1336.46 860.444,1357.43 884.512,1377.38 908.58,1396.34 932.648,1414.37 956.716,1431.51 980.784,1447.8 1004.85,1463.29 1028.92,1478.02 1052.99,1492.03 1077.06,1505.34 1101.12,1518 1125.19,1530.04 1149.26,1541.48 1173.33,1552.36 1197.4,1562.7 1221.46,1572.54 1245.53,1581.89 1269.6,1590.78 1293.67,1599.23 1317.74,1607.26 1341.8,1614.9 1365.87,1622.16 1389.94,1629.07 1414.01,1635.63 1438.08,1641.88 1462.14,1647.81 1486.21,1653.45 1510.28,1658.82 1534.35,1663.92 1558.42,1668.77 1582.48,1673.38 1606.55,1677.76 1630.62,1681.93 1654.69,1685.89 1678.76,1689.66 1702.82,1693.24 1726.89,1696.64 1750.96,1699.88 1775.03,1702.96 1799.1,1705.88 1823.17,1708.67 1847.23,1711.31 1871.3,1713.83 1895.37,1716.22 1919.44,1718.49 1943.51,1720.65 1967.57,1722.71 1991.64,1724.66 2015.71,1726.52 2039.78,1728.28 2063.85,1729.96 2087.91,1731.56 2111.98,1733.08 2136.05,1734.52 2160.12,1735.89 2184.19,1737.2 2208.25,1738.44 2232.32,1739.61 2256.39,1740.74 2280.46,1741.8 2304.53,1742.81 2328.59,1743.78 2352.66,1744.69 2376.73,1745.56 2400.8,1746.39 2424.87,1747.18 2448.93,1747.93 2473,1748.64 2497.07,1749.32 2521.14,1749.96 2545.21,1750.57 2569.27,1751.15 "></polyline>
<path clip-path="url(#clip320)" d="M2251.57 209.375 L2556.57 209.375 L2556.57 105.695 L2251.57 105.695  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip320)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2251.57,209.375 2556.57,209.375 2556.57,105.695 2251.57,105.695 2251.57,209.375 "></polyline>
<polyline clip-path="url(#clip320)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2279.63,157.535 2448.01,157.535 "></polyline>
<path clip-path="url(#clip320)" d="M2489.91 177.223 Q2488.11 181.852 2486.4 183.264 Q2484.68 184.676 2481.81 184.676 L2478.41 184.676 L2478.41 181.112 L2480.91 181.112 Q2482.67 181.112 2483.64 180.278 Q2484.61 179.445 2485.79 176.343 L2486.56 174.399 L2476.07 148.889 L2480.59 148.889 L2488.69 169.167 L2496.79 148.889 L2501.3 148.889 L2489.91 177.223 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip320)" d="M2508.6 170.88 L2516.23 170.88 L2516.23 144.515 L2507.92 146.181 L2507.92 141.922 L2516.19 140.255 L2520.86 140.255 L2520.86 170.88 L2528.5 170.88 L2528.5 174.815 L2508.6 174.815 L2508.6 170.88 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
</div>
<p>Perfect! While it may seem that we introduced a ton of machinery for no reason, we have effectively removed the boilerplate for common tasks such as the condition-effect structure and data saving. The work we put into this allows us to write clean and intuitive code when we want to do more things within a callback. Perhaps a realistic use-case is to specify dynamical conditions that kick in at some intermediate time, for example, a random kick every <code>n</code> iterations. We could also constrain the solution from going below a certain threshold.</p>
<div id="f452e3d2" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    record_state <span class="op">=</span> <span class="fu">Callback</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">OnIterElapsed</span>(<span class="fl">1</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">RecordObservable</span>((u<span class="op">=</span>(iter, integrator) <span class="op">-&gt;</span> integrator.u[<span class="fl">1</span>],))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    hardwall_callback <span class="op">=</span> <span class="fu">Callback</span>(</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        (iter, integrator) <span class="op">-&gt;</span> integrator.u[<span class="fl">1</span>] <span class="op">&lt;</span> <span class="fl">1</span>.,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        (iter, integrator) <span class="op">-&gt;</span> integrator.u[<span class="fl">1</span>] <span class="op">=</span> <span class="fl">1</span>.,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    kick_callback <span class="op">=</span> <span class="fu">Callback</span>(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">OnIterElapsed</span>(<span class="fl">30</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        (iter, integrator) <span class="op">-&gt;</span> integrator.u[<span class="fl">1</span>] <span class="op">+=</span> <span class="fu">rand</span>(),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">solve!</span>(dfdt!, [<span class="fl">5.0</span>], <span class="fu">range</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>, length<span class="op">=</span><span class="fl">100</span>), solver<span class="op">=</span>RK4Integrator, (callback!)<span class="op">=</span><span class="fu">CallbackList</span>([record_state, hardwall_callback, kick_callback]))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(record_state.effect.u, ylims <span class="op">=</span> [<span class="fl">0</span>., <span class="fl">5.1</span>])</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="519">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip410">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip410)" d="M0 1920 L2688 1920 L2688 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip411">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip410)" d="M115.057 1800.78 L2640.76 1800.78 L2640.76 47.2441 L115.057 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip412">
    <rect x="115" y="47" width="2527" height="1755"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="162.471,1800.78 162.471,47.2441 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="764.172,1800.78 764.172,47.2441 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1365.87,1800.78 1365.87,47.2441 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1967.57,1800.78 1967.57,47.2441 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2569.27,1800.78 2569.27,47.2441 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1456.95 2640.76,1456.95 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,1113.12 2640.76,1113.12 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,769.288 2640.76,769.288 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,425.458 2640.76,425.458 "></polyline>
<polyline clip-path="url(#clip412)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="115.057,81.6271 2640.76,81.6271 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 2640.76,1800.78 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="162.471,1800.78 162.471,1781.88 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="764.172,1800.78 764.172,1781.88 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1365.87,1800.78 1365.87,1781.88 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1967.57,1800.78 1967.57,1781.88 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2569.27,1800.78 2569.27,1781.88 "></polyline>
<path clip-path="url(#clip410)" d="M162.471 1834 Q158.86 1834 157.031 1837.57 Q155.226 1841.11 155.226 1848.24 Q155.226 1855.34 157.031 1858.91 Q158.86 1862.45 162.471 1862.45 Q166.105 1862.45 167.911 1858.91 Q169.74 1855.34 169.74 1848.24 Q169.74 1841.11 167.911 1837.57 Q166.105 1834 162.471 1834 M162.471 1830.3 Q168.281 1830.3 171.337 1834.9 Q174.416 1839.49 174.416 1848.24 Q174.416 1856.96 171.337 1861.57 Q168.281 1866.15 162.471 1866.15 Q156.661 1866.15 153.582 1861.57 Q150.527 1856.96 150.527 1848.24 Q150.527 1839.49 153.582 1834.9 Q156.661 1830.3 162.471 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M743.443 1861.55 L759.762 1861.55 L759.762 1865.48 L737.818 1865.48 L737.818 1861.55 Q740.48 1858.79 745.063 1854.16 Q749.67 1849.51 750.85 1848.17 Q753.096 1845.65 753.975 1843.91 Q754.878 1842.15 754.878 1840.46 Q754.878 1837.71 752.933 1835.97 Q751.012 1834.23 747.91 1834.23 Q745.711 1834.23 743.258 1835 Q740.827 1835.76 738.049 1837.31 L738.049 1832.59 Q740.873 1831.46 743.327 1830.88 Q745.781 1830.3 747.818 1830.3 Q753.188 1830.3 756.383 1832.98 Q759.577 1835.67 759.577 1840.16 Q759.577 1842.29 758.767 1844.21 Q757.98 1846.11 755.873 1848.7 Q755.295 1849.37 752.193 1852.59 Q749.091 1855.78 743.443 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M769.623 1830.92 L787.98 1830.92 L787.98 1834.86 L773.906 1834.86 L773.906 1843.33 Q774.924 1842.98 775.943 1842.82 Q776.961 1842.64 777.98 1842.64 Q783.767 1842.64 787.146 1845.81 Q790.526 1848.98 790.526 1854.4 Q790.526 1859.97 787.054 1863.08 Q783.581 1866.15 777.262 1866.15 Q775.086 1866.15 772.818 1865.78 Q770.572 1865.41 768.165 1864.67 L768.165 1859.97 Q770.248 1861.11 772.47 1861.66 Q774.693 1862.22 777.169 1862.22 Q781.174 1862.22 783.512 1860.11 Q785.85 1858.01 785.85 1854.4 Q785.85 1850.78 783.512 1848.68 Q781.174 1846.57 777.169 1846.57 Q775.294 1846.57 773.419 1846.99 Q771.568 1847.4 769.623 1848.28 L769.623 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M1340.57 1830.92 L1358.93 1830.92 L1358.93 1834.86 L1344.85 1834.86 L1344.85 1843.33 Q1345.87 1842.98 1346.89 1842.82 Q1347.91 1842.64 1348.93 1842.64 Q1354.72 1842.64 1358.09 1845.81 Q1361.47 1848.98 1361.47 1854.4 Q1361.47 1859.97 1358 1863.08 Q1354.53 1866.15 1348.21 1866.15 Q1346.03 1866.15 1343.77 1865.78 Q1341.52 1865.41 1339.11 1864.67 L1339.11 1859.97 Q1341.2 1861.11 1343.42 1861.66 Q1345.64 1862.22 1348.12 1862.22 Q1352.12 1862.22 1354.46 1860.11 Q1356.8 1858.01 1356.8 1854.4 Q1356.8 1850.78 1354.46 1848.68 Q1352.12 1846.57 1348.12 1846.57 Q1346.24 1846.57 1344.37 1846.99 Q1342.52 1847.4 1340.57 1848.28 L1340.57 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M1380.69 1834 Q1377.08 1834 1375.25 1837.57 Q1373.44 1841.11 1373.44 1848.24 Q1373.44 1855.34 1375.25 1858.91 Q1377.08 1862.45 1380.69 1862.45 Q1384.32 1862.45 1386.13 1858.91 Q1387.96 1855.34 1387.96 1848.24 Q1387.96 1841.11 1386.13 1837.57 Q1384.32 1834 1380.69 1834 M1380.69 1830.3 Q1386.5 1830.3 1389.55 1834.9 Q1392.63 1839.49 1392.63 1848.24 Q1392.63 1856.96 1389.55 1861.57 Q1386.5 1866.15 1380.69 1866.15 Q1374.88 1866.15 1371.8 1861.57 Q1368.74 1856.96 1368.74 1848.24 Q1368.74 1839.49 1371.8 1834.9 Q1374.88 1830.3 1380.69 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M1941.43 1830.92 L1963.65 1830.92 L1963.65 1832.91 L1951.1 1865.48 L1946.22 1865.48 L1958.02 1834.86 L1941.43 1834.86 L1941.43 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M1972.82 1830.92 L1991.17 1830.92 L1991.17 1834.86 L1977.1 1834.86 L1977.1 1843.33 Q1978.12 1842.98 1979.14 1842.82 Q1980.15 1842.64 1981.17 1842.64 Q1986.96 1842.64 1990.34 1845.81 Q1993.72 1848.98 1993.72 1854.4 Q1993.72 1859.97 1990.25 1863.08 Q1986.77 1866.15 1980.46 1866.15 Q1978.28 1866.15 1976.01 1865.78 Q1973.77 1865.41 1971.36 1864.67 L1971.36 1859.97 Q1973.44 1861.11 1975.66 1861.66 Q1977.89 1862.22 1980.36 1862.22 Q1984.37 1862.22 1986.71 1860.11 Q1989.04 1858.01 1989.04 1854.4 Q1989.04 1850.78 1986.71 1848.68 Q1984.37 1846.57 1980.36 1846.57 Q1978.49 1846.57 1976.61 1846.99 Q1974.76 1847.4 1972.82 1848.28 L1972.82 1830.92 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M2528.88 1861.55 L2536.52 1861.55 L2536.52 1835.18 L2528.21 1836.85 L2528.21 1832.59 L2536.47 1830.92 L2541.15 1830.92 L2541.15 1861.55 L2548.79 1861.55 L2548.79 1865.48 L2528.88 1865.48 L2528.88 1861.55 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M2568.23 1834 Q2564.62 1834 2562.79 1837.57 Q2560.99 1841.11 2560.99 1848.24 Q2560.99 1855.34 2562.79 1858.91 Q2564.62 1862.45 2568.23 1862.45 Q2571.87 1862.45 2573.67 1858.91 Q2575.5 1855.34 2575.5 1848.24 Q2575.5 1841.11 2573.67 1837.57 Q2571.87 1834 2568.23 1834 M2568.23 1830.3 Q2574.04 1830.3 2577.1 1834.9 Q2580.18 1839.49 2580.18 1848.24 Q2580.18 1856.96 2577.1 1861.57 Q2574.04 1866.15 2568.23 1866.15 Q2562.42 1866.15 2559.34 1861.57 Q2556.29 1856.96 2556.29 1848.24 Q2556.29 1839.49 2559.34 1834.9 Q2562.42 1830.3 2568.23 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M2598.39 1834 Q2594.78 1834 2592.95 1837.57 Q2591.15 1841.11 2591.15 1848.24 Q2591.15 1855.34 2592.95 1858.91 Q2594.78 1862.45 2598.39 1862.45 Q2602.03 1862.45 2603.83 1858.91 Q2605.66 1855.34 2605.66 1848.24 Q2605.66 1841.11 2603.83 1837.57 Q2602.03 1834 2598.39 1834 M2598.39 1830.3 Q2604.2 1830.3 2607.26 1834.9 Q2610.34 1839.49 2610.34 1848.24 Q2610.34 1856.96 2607.26 1861.57 Q2604.2 1866.15 2598.39 1866.15 Q2592.58 1866.15 2589.51 1861.57 Q2586.45 1856.96 2586.45 1848.24 Q2586.45 1839.49 2589.51 1834.9 Q2592.58 1830.3 2598.39 1830.3 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 115.057,47.2441 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1800.78 133.955,1800.78 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1456.95 133.955,1456.95 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,1113.12 133.955,1113.12 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,769.288 133.955,769.288 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,425.458 133.955,425.458 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="115.057,81.6271 133.955,81.6271 "></polyline>
<path clip-path="url(#clip410)" d="M62.7928 1786.58 Q59.1817 1786.58 57.353 1790.14 Q55.5475 1793.68 55.5475 1800.81 Q55.5475 1807.92 57.353 1811.49 Q59.1817 1815.03 62.7928 1815.03 Q66.427 1815.03 68.2326 1811.49 Q70.0613 1807.92 70.0613 1800.81 Q70.0613 1793.68 68.2326 1790.14 Q66.427 1786.58 62.7928 1786.58 M62.7928 1782.87 Q68.6029 1782.87 71.6585 1787.48 Q74.7372 1792.06 74.7372 1800.81 Q74.7372 1809.54 71.6585 1814.15 Q68.6029 1818.73 62.7928 1818.73 Q56.9826 1818.73 53.904 1814.15 Q50.8484 1809.54 50.8484 1800.81 Q50.8484 1792.06 53.904 1787.48 Q56.9826 1782.87 62.7928 1782.87 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M54.8299 1470.29 L62.4687 1470.29 L62.4687 1443.93 L54.1586 1445.59 L54.1586 1441.34 L62.4224 1439.67 L67.0983 1439.67 L67.0983 1470.29 L74.7372 1470.29 L74.7372 1474.23 L54.8299 1474.23 L54.8299 1470.29 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M58.4178 1126.46 L74.7372 1126.46 L74.7372 1130.4 L52.7928 1130.4 L52.7928 1126.46 Q55.4549 1123.71 60.0382 1119.08 Q64.6446 1114.43 65.8252 1113.08 Q68.0705 1110.56 68.9502 1108.82 Q69.8529 1107.07 69.8529 1105.38 Q69.8529 1102.62 67.9085 1100.88 Q65.9872 1099.15 62.8854 1099.15 Q60.6863 1099.15 58.2326 1099.91 Q55.8021 1100.68 53.0243 1102.23 L53.0243 1097.51 Q55.8484 1096.37 58.3021 1095.79 Q60.7558 1095.21 62.7928 1095.21 Q68.1631 1095.21 71.3576 1097.9 Q74.552 1100.58 74.552 1105.07 Q74.552 1107.2 73.7418 1109.13 Q72.9548 1111.02 70.8483 1113.62 Q70.2696 1114.29 67.1678 1117.5 Q64.0659 1120.7 58.4178 1126.46 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M67.6076 767.934 Q70.964 768.651 72.839 770.92 Q74.7372 773.188 74.7372 776.522 Q74.7372 781.637 71.2187 784.438 Q67.7002 787.239 61.2187 787.239 Q59.0428 787.239 56.728 786.799 Q54.4364 786.383 51.9827 785.526 L51.9827 781.012 Q53.9271 782.147 56.2419 782.725 Q58.5567 783.304 61.0798 783.304 Q65.478 783.304 67.7696 781.568 Q70.0844 779.832 70.0844 776.522 Q70.0844 773.466 67.9317 771.753 Q65.802 770.017 61.9826 770.017 L57.9549 770.017 L57.9549 766.175 L62.1678 766.175 Q65.6169 766.175 67.4455 764.809 Q69.2742 763.42 69.2742 760.827 Q69.2742 758.165 67.3761 756.753 Q65.5011 755.318 61.9826 755.318 Q60.0613 755.318 57.8623 755.735 Q55.6632 756.152 53.0243 757.031 L53.0243 752.864 Q55.6864 752.124 58.0012 751.753 Q60.3391 751.383 62.3993 751.383 Q67.7233 751.383 70.8252 753.814 Q73.927 756.221 73.927 760.341 Q73.927 763.212 72.2835 765.202 Q70.64 767.17 67.6076 767.934 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M65.1539 412.252 L53.3484 430.701 L65.1539 430.701 L65.1539 412.252 M63.927 408.178 L69.8066 408.178 L69.8066 430.701 L74.7372 430.701 L74.7372 434.589 L69.8066 434.589 L69.8066 442.738 L65.1539 442.738 L65.1539 434.589 L49.5521 434.589 L49.5521 430.076 L63.927 408.178 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M53.8345 64.3471 L72.1909 64.3471 L72.1909 68.2823 L58.1169 68.2823 L58.1169 76.7545 Q59.1354 76.4073 60.1539 76.2452 Q61.1724 76.06 62.1909 76.06 Q67.978 76.06 71.3576 79.2313 Q74.7372 82.4026 74.7372 87.8192 Q74.7372 93.3979 71.265 96.4997 Q67.7928 99.5784 61.4734 99.5784 Q59.2974 99.5784 57.0289 99.2081 Q54.7836 98.8377 52.3762 98.097 L52.3762 93.3979 Q54.4595 94.5322 56.6817 95.0877 Q58.9039 95.6433 61.3808 95.6433 Q65.3854 95.6433 67.7233 93.5368 Q70.0613 91.4303 70.0613 87.8192 Q70.0613 84.2081 67.7233 82.1017 Q65.3854 79.9952 61.3808 79.9952 Q59.5058 79.9952 57.6308 80.4119 Q55.7789 80.8285 53.8345 81.7082 L53.8345 64.3471 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip412)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="186.539,166.297 210.607,246.797 234.675,323.332 258.743,396.097 282.811,465.279 306.879,531.054 330.947,593.589 355.015,653.044 379.083,709.571 403.151,763.314 427.219,814.41 451.288,862.989 475.356,909.176 499.424,953.089 523.492,994.838 547.56,1034.53 571.628,1072.27 595.696,1108.15 619.764,1142.26 643.832,1174.69 667.9,1205.53 691.968,1234.85 716.036,1262.72 740.104,1289.22 764.172,1314.41 788.24,1338.37 812.308,1361.14 836.376,1382.79 860.444,1403.38 884.512,1422.95 908.58,1332.21 932.648,1355.29 956.716,1377.23 980.784,1398.09 1004.85,1417.92 1028.92,1436.78 1052.99,1454.71 1077.06,1471.75 1101.12,1473.88 1125.19,1473.88 1149.26,1473.88 1173.33,1473.88 1197.4,1473.88 1221.46,1473.88 1245.53,1473.88 1269.6,1473.88 1293.67,1473.88 1317.74,1473.88 1341.8,1473.88 1365.87,1473.88 1389.94,1473.88 1414.01,1473.88 1438.08,1473.88 1462.14,1473.88 1486.21,1473.88 1510.28,1473.88 1534.35,1473.88 1558.42,1473.88 1582.48,1473.88 1606.55,1473.88 1630.62,1183.38 1654.69,1213.79 1678.76,1242.7 1702.82,1270.18 1726.89,1296.32 1750.96,1321.16 1775.03,1344.78 1799.1,1367.24 1823.17,1388.59 1847.23,1408.89 1871.3,1428.19 1895.37,1446.54 1919.44,1463.99 1943.51,1473.88 1967.57,1473.88 1991.64,1473.88 2015.71,1473.88 2039.78,1473.88 2063.85,1473.88 2087.91,1473.88 2111.98,1473.88 2136.05,1473.88 2160.12,1473.88 2184.19,1473.88 2208.25,1473.88 2232.32,1473.88 2256.39,1473.88 2280.46,1473.88 2304.53,1473.88 2328.59,1473.88 2352.66,1215.95 2376.73,1244.76 2400.8,1272.14 2424.87,1298.18 2448.93,1322.93 2473,1346.47 2497.07,1368.84 2521.14,1390.11 2545.21,1410.34 2569.27,1429.57 "></polyline>
<path clip-path="url(#clip410)" d="M2251.57 209.375 L2556.57 209.375 L2556.57 105.695 L2251.57 105.695  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip410)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2251.57,209.375 2556.57,209.375 2556.57,105.695 2251.57,105.695 2251.57,209.375 "></polyline>
<polyline clip-path="url(#clip410)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2279.63,157.535 2448.01,157.535 "></polyline>
<path clip-path="url(#clip410)" d="M2489.91 177.223 Q2488.11 181.852 2486.4 183.264 Q2484.68 184.676 2481.81 184.676 L2478.41 184.676 L2478.41 181.112 L2480.91 181.112 Q2482.67 181.112 2483.64 180.278 Q2484.61 179.445 2485.79 176.343 L2486.56 174.399 L2476.07 148.889 L2480.59 148.889 L2488.69 169.167 L2496.79 148.889 L2501.3 148.889 L2489.91 177.223 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip410)" d="M2508.6 170.88 L2516.23 170.88 L2516.23 144.515 L2507.92 146.181 L2507.92 141.922 L2516.19 140.255 L2520.86 140.255 L2520.86 170.88 L2528.5 170.88 L2528.5 174.815 L2508.6 174.815 L2508.6 170.88 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
</div>
<p>I think this is quite a nice example demonstrating how the callback pattern allows modularity and extensibility for the user with no need to poke into the internals of the core solver loop. However, it should be noted that design patterns such as this one tend to quickly ramp up in complexity and the overhead introduced both in compilation time and developer maintanence time can often outweigh its usefulness. So its important to keep your specific use-case in mind and try to use such constructions only when strictly required.</p>
<p>Before we conclude, it is important to note that the example presented above is a fairly specific utilization of callbacks in the context of scientific software where one may want to inject custom logic inside a core program loop. On the other hand, the concept is also widely prevalent in video game programming and web development, typically presenting itself in the context of <a href="https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Async_JS/Introducing">asynchronous programming</a>. While the key idea still remains that the invocation of a function is deferred until some other function is completed, the resulting interfaces may take up a different form than we see here. Perhaps that is a topic for another time.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/20akshay00\.github\.io\/ResearchTidbits\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>